<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ECI signatures</title>

    <link href="dist/style.css" rel="stylesheet">

<style>
 #channel g.row text {fill: grey;};
.countries {stroke:grey;stroke-width:1;}
</style>
  </head>
  <body>
  <div class="container" role="main">
<div class="page-header"></div>
<div class="row">
<div id="date" class="col-md-12"><div class="panel panel-default"><div class="panel-heading">Date

<div class="btn-group" id="btn-date"></div>

</div>
<div class="panel-body"> <div class="graph"></div></div></div>
</div>
</div>
<div class="row">
	<div class="col-md-3">
		<div id="overview">
			<ul class="list-group">
				<li class="list-group-item"><span class="summary_total"></span> total</button></li>
				<li class="list-group-item list-group-item-success"><span class="badge total_percent"></span><span class="total"></span> signatures</button></li>
			</ul>
</div>
	</div>
<div id="channel" class="col-md-3"><div class="panel panel-default">
  <div class="panel-heading" title="click to select campaigns">
<th><input id="input-filter" placeholder="Channel" title="search on channel"/>
</div>
<div class="panel-body"> <div class="graph"></div></div></div></div>
<div id="country" class="col-md-6"><div class="panel panel-default">
<div class="panel-heading">Country</div><div class="panel-body"> <div class="graph"></div></div></div></div>

</div>


    <div class="row">
      <div class="col-md-12">
<div id="map"></div>
      <table class="table table-striped hidden" id="table">
        <thead>
          <tr>
            <th>Channel</th>
            <th>Country</th>
            <th>Total</th>
          </tr>
        </thead>
      </table>
      </div>
    </div>
  </div>

    <script src="dist/all.js"></script>
 
    <script>
"use strict";
var country = [{"country":"at","threshold":14250}
,{"country":"be","threshold":16500}
,{"country":"bg","threshold":13500}
,{"country":"cy","threshold":4500}
,{"country":"cz","threshold":16500}
,{"country":"de","threshold":74250}
,{"country":"dk","threshold":9750}
,{"country":"ee","threshold":4500}
,{"country":"el","threshold":16500}
,{"country":"es","threshold":40500}
,{"country":"fi","threshold":9750}
,{"country":"fr","threshold":55500}
,{"country":"hr","threshold":9000}
,{"country":"hu","threshold":16500}
,{"country":"ie","threshold":9000}
,{"country":"it","threshold":54750}
,{"country":"lt","threshold":9000}
,{"country":"lu","threshold":4500}
,{"country":"lv","threshold":6750}
,{"country":"mt","threshold":4500}
,{"country":"nl","threshold":19500}
,{"country":"pl","threshold":38250}
,{"country":"pt","threshold":16500}
,{"country":"ro","threshold":24750}
,{"country":"se","threshold":15000}
,{"country":"si","threshold":6000}
,{"country":"sk","threshold":9750}
,{"country":"uk","threshold":54750}];

  function setUrl(){
   var country=graphs.country.filters();
   var channel=$("#input-filter").val();
   var url="?";
   if (country && country.length > 0) url +="country="+country+"&";
   if (channel) url +="channel="+channel+"&";
   window.history.pushState(null, country + " " + channel, url);

  };

  function hasFilter() {
    return $.urlParam("country") || $.urlParam("channel");
  };

  jQuery.urlParam = function(name){
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results==null){
       return null;
    }
    else{
       return decodeURI(results[1]) || 0;
    }
};
    var graphs = [];
    var summary= {};
  var europe=null;
  var data=null;

  var q=d3.queue()
    .defer (function(callback) {
      d3.json("data/europe50b.json", function(error, json) {
        europe=json;
        callback();
      });
    })
    .defer (function(callback) {
      d3.csv("data/openeci.csv", function(error, csv) {
        data=csv;
        callback();
      });
    })
    .await(function (){
      draw();
    });

    function draw () {
      
      var dateFormat = d3.time.format.utc("%Y-%m-%d");
      var formatNumber = function (d){ return d3.format(",")(d).replace(",","'")};
 
      data.forEach(function(d) {
        d.total = + d.total;
        d.date = dateFormat.parse(d.date);
      }); 
      var ndx = crossfilter(data);

//      graphs.pie = drawPie("#test");
      graphs.channel = drawChannel("#channel .graph");
      graphs.country = drawCountry("#country .graph");
      graphs.date = drawDate("#date .graph");
      graphs.btn_date = drawDateButton("#date .btn-group",graphs.date);
      graphs.map = drawMap ("#map");
//      graphs.table = drawTable("#table");
      drawNumbers(graphs); 
      graphs.total.on("postRedraw", function(){setUrl()});

      summary.total = graphs.total.data();


      jQuery (function($) {
        graphs.search = drawTextSearch('#input-filter',jQuery);
        $(".summary_total").text(formatNumber(summary.total));
        $("#input-filter").val($.urlParam("channel")).keyup();//if channel param, filter
        if ($.urlParam("country")){
          $.urlParam("country").split(',').forEach(function(d){
            graphs.country.filter(d);//if channel param, filter
          });
        }
        if (!hasFilter())
          $("#date button")[0].click(); //select today
        dc.renderAll();
      });


function drawNumbers (graphs){
  var formatPercent =d3.format(".2%");

  
  var group = ndx.groupAll().reduce(
    function (p, v) {
	p.total += +v.total;
	return p;
    },
    function (p, v) {
	p.total -= +v.total;
	return p;
    },
    function () { return {
       total:0,
      };
    });
  
  graphs.total=dc.numberDisplay(".total") 
	    .valueAccessor(function(d){ return d.total})
    .formatNumber(formatNumber)
    .group(group);
  graphs.total_percent=dc.numberDisplay(".total_percent") 
	    .valueAccessor(function(d){ return d.total/summary.total})
    .formatNumber(formatPercent)
    .group(group);
}

function drawMap (dom) {
  var width=800;
  var dim = ndx.dimension(function(d) {return d.country.toUpperCase();});
  var group = dim.group().reduceSum(function(d) {return d.total;})
  
      var _colors = d3.scale.linear().range(["red","orange","green","#4D4D4D"])
.domain([0,0.9,1,1.1,10000]);;
//      var _colorRange = ["green","#08551e","#ff6f00","#be1700","#4D4D4D","pink"];
//      var _colors = d3.scale.ordinal().range(_colorRange).domain([0,0.9,1,1.1,10000]);


var projection = d3.geo.equirectangular()
    .center([18,52]) //theorically, 50°7′2.23″N 9°14′51.97″E but this works
    .scale(width*0.8);
  var geojson=topojson.feature(europe,europe.objects.countries);
   
  var map = dc.geoChoroplethChart(dom)
	.height(width*0.8)
	.width(width)
	.dimension(dim)
	.projection(projection)
  .colorAccessor(function(v,i){
    return v;
    //var d=this.group().all()[i];
    console.log(i+":"+v);
    var c=country.find(function(c) {return c.country.toUpperCase()==d.key});
    if (!c) return 0;
    return v/c.threshold;
  })
	.group(group)
  .colors(_colors)
//	.colorCalculator(_colorCalculator)
	.overlayGeoJson(geojson.features,"countries",function(d){
	   return d.id;
	})
	.title(function (d) {return "" + d.key + ': ' + d.value;                                                        });
		
		
	map.on("renderlet.a",function (chart){
	  chart.selectAll(".countries").on("mouseover", function (d) {
	    //console.log(d3.select(this));
	    $("#explanation").html ("<h3>"+d.properties.name+"</h3>");
	  });
	
	  chart.selectAll(".countries").on("click", function (d) {
								    //$('.bar.'+'1').addClass('selectedbar');
										//barchart.filterAll();
										//barchart.redraw();
	  })
       }); 

};

function drawDateButton(dom, graph) {
var data = [
    { key: "today", label: "Today" },
    { key: "yesterday", label: "Yesterday" },
    { key: "week", label: "This week" },
    { key: "month", label: "This month" },
    { key: "Infinity", label: "All" }
];
  d3.select(dom)
    .selectAll("button")
    .data(data)
    .enter()
    .append ("button")
    .text(function (d) {return d.label})
    .classed("btn",true)
    .classed("btn-default",true)
    .on("click", function () {
       var btn=d3.select(this);
       d3.selectAll(dom +" .active").classed("active", false);
       btn.classed("active",true);
	    var s = new Date(), e = new Date();
	    switch (btn.data()[0].key) {
	      case "today":
		s = d3.time.day.utc(e);
		break;
	      case "yesterday":
		e = d3.time.day.utc(s);
		s = d3.time.day.offset(e, -1);
		break;
	      case "week":
		s = d3.time.monday.utc(e);
		break;
	      case "month":
		s = d3.time.month.utc(e);
		break;
	      default:
		s = d3.time.day.offset(e, - + btn.data()[0].key);
	    }

	    graph.filterAll(); //reset filter
	    graph.filter(dc.filters.RangedFilter(s,e));
	    graph.redrawGroup();
    });


}

function drawDate (dom) {
  var dim = ndx.dimension(function(d){return d.date;});//already grouped by day
  var group = dim.group().reduceSum(function(d){return d.total;});
  var graph=dc.lineChart(dom)
   .margins({top: 0, right: 20, bottom: 20, left:30})
    .height(150)
    .width(650)
    .dimension(dim)
    .renderArea(true)
    .group(group)
    .brushOn(false)
    .title (function(d) {return dateFormat(d.key)+": "+d.value+" signatures"})
    .x(d3.time.scale.utc().domain([dim.bottom(1)[0].date,dim.top(1)[0].date]))
    .round(d3.time.day.utc.round)
    .elasticY(true)
    .xUnits(d3.time.days.utc);

   graph.yAxis().ticks(5).tickFormat(d3.format(".2s"));
   graph.xAxis().ticks(7);

  return graph;
}

      function drawCountry (dom) {
        var dim  = ndx.dimension(function(d) {return d.country;});
        var group = dim.group().reduceSum(function(d) {return d.total;});
        var chart = dc.pieChart(dom)
          .width(200)
          .height(200)
          .innerRadius(10)
          .dimension(dim)
          .group(group);
   
          return chart;
      }
    
function drawTextSearch (dom,$,val) {

  var dim = ndx.dimension(function(d) { return d.channel});

  var throttleTimer;

  $(dom).keyup (function () {

    var s = jQuery(this ).val().toLowerCase();
    $(".resetall").attr("disabled",false);
    throttle();

    function throttle() {
      window.clearTimeout(throttleTimer);
      throttleTimer = window.setTimeout(function() {
        dim.filterAll();
        dim.filterFunction(function (d) { return d.indexOf (s) !== -1;} );
	dc.redrawAll();
      }, 250);
    }
  });

  return dim;

}
      function drawChannel (dom) {
	  var dim = ndx.dimension(
         function(d){
         return d.channel;
       });
	  var group = dim.group()
	//  .reduce(reduceAdd,reduceRemove,reduceInitial);
	.reduceSum(function(d){return d.total;});
	  var graph  = dc.rowChart(dom)
	    .width(200)
	    .height(275)
	    .gap(0)
	    .rowsCap(18)
	    .ordering(function(d) { return -d.value })
	//    .ordering(function(d) { return -d.value.count })
	//    .valueAccessor( function(d) { return d.value.count })
	//    .label (function (d) {return d.key;})
	//    .title (function (d) {return d.key + ":" + d.value.count + "\nsignatures:" + d.value.sign + "\nnew:"+d.value.sign_new;})
	    .dimension(dim)
	    .elasticX(true)
	.labelOffsetY(10)
	.fixedBarHeight(14)
	.labelOffsetX(2)
        .colorCalculator(function(d){return 'lightblue';})
	.group(group);

    graph.xAxis().ticks(4);
    graph.margins().left = 5;
    graph.margins().top = 0;
    graph.margins().bottom = 0;
	  return graph;
	}

      function drawTable (dom) {
        var dim  = ndx.dimension(function(d) {return null;});
        var chart= dc.dataTable(dom)
              .dimension(dim)
              .size(1000)
              .group(function (d) { return "<b>"+dateFormat(d.date)+"</b>";})
              .columns([
                  function (d) {
                      return d.channel;
                  },
                  function (d) {
                      return d.country;
                  },
                  function (d) {
                      return d.total;
                  }
              ])
              .sortBy(function (d) {
                  return d.total;
              })
              .order(d3.descending);
        return chart;

      }

    };






    </script>

  </body>
</html>

